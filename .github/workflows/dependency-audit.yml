name: Dependency Audit

on:
  # Run weekly on Monday morning
  schedule:
    - cron: '0 9 * * 1'
  # Allow manual trigger
  workflow_dispatch:
  # Run on pushes to master (but not PRs)
  push:
    branches:
      - master

env:
  CARGO_TERM_COLOR: always

jobs:
  audit:
    name: Check dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: erlef/setup-beam@v1
        with:
          otp-version: 28.2
          elixir-version: 1.19.4

      - uses: dtolnay/rust-toolchain@stable

      - name: Install Elixir deps
        run: mix deps.get

      - name: Check for outdated Elixir dependencies
        run: mix hex.outdated

      # Cache cargo binaries
      - uses: actions/cache@v4
        id: cargo-tools-cache
        with:
          path: |
            ~/.cargo/bin/cargo-outdated
            ~/.cargo/bin/cargo-deny
          key: cargo-tools-${{ runner.os }}-v2

      - name: Install cargo-binstall
        if: steps.cargo-tools-cache.outputs.cache-hit != 'true'
        uses: cargo-bins/cargo-binstall@main

      - name: Install cargo tools
        if: steps.cargo-tools-cache.outputs.cache-hit != 'true'
        run: cargo binstall --no-confirm cargo-outdated cargo-deny

      - name: Check for outdated Rust dependencies
        run: cd native/pcap_file_ex && cargo outdated --exit-code 0

      - name: Check for security advisories and license issues
        run: cd native/pcap_file_ex && cargo deny check advisories licenses
